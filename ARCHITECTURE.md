# 🏗️ 项目架构说明

### 技术架构价值
- **高性能**: 共享数据机制减少90%API调用，批量分析速度提升5倍
- **高可用**: 多Key轮换机制，API成功率达99.5%以上
- **易维护**: 分层架构设计，主页面代码从80行优化到3行
- **类型安全**: 全TypeScript开发，编译期错误检查，运行时稳定性高

## 📁 目录结构

```
bn-alpha-tool/
├── app/                    # Next.js 14 App Router
│   ├── api/               # API路由
│   ├── globals.css        # 全局样式
│   ├── layout.tsx         # 根布局
│   └── page.tsx           # 主页面 (Server Component)
├── components/            # React组件
│   ├── ui/               # 基础UI组件 (shadcn/ui)
│   ├── app-shell.tsx     # 客户端应用外壳
│   └── [other-components] # 业务组件
├── services/             # 服务层
│   ├── api/              # API服务
│   ├── analysis/         # 业务分析服务
│   └── data/             # 数据服务
├── stores/               # 状态管理 (Zustand)
├── types/                # TypeScript类型定义
├── lib/                  # 工具库
├── hooks/                # 自定义Hook
└── __tests__/            # 测试文件
```

## 🏛️ 分层架构

### 1. 应用层 (App Layer)
```
app/page.tsx (Server Component)
       ↓
components/app-shell.tsx (Client Component)
       ↓
业务组件 (dashboard, revenue-display, etc.)
```

**职责**：
- **Server Component**: 静态内容渲染，SEO优化
- **Client Component**: 客户端交互，状态管理
- **业务组件**: 具体功能实现

### 2. 状态管理层 (State Management)
```
stores/wallet-store.ts     # 钱包数据状态
stores/ui-store.ts         # UI状态管理
```

**特性**：
- **Zustand**: 轻量级状态管理
- **持久化**: localStorage自动保存
- **类型安全**: 完整TypeScript支持

### 3. 业务服务层 (Business Services)
```
services/analysis/
├── balance-service.ts     # 余额分析
└── transaction-service.ts # 交易分析
```

**职责**：
- 业务逻辑封装
- 数据处理和计算
- 结果缓存优化

#### 核心业务逻辑详解

**1. 余额分析服务 (BalanceService)**
- **多代币余额查询**: 同时获取钱包中的BNB、USDT、ZKJ、KOGE等代币余额
- **实时价格转换**: 将所有代币余额统一转换为USDT价值，便于积分计算
- **积分权重计算**: 根据不同代币的积分权重，计算总的余额积分
- **缓存优化**: 余额数据缓存5分钟，避免频繁查询相同钱包

**2. 交易分析服务核心逻辑**

**交易数据获取阶段**:
- **时间范围确定**: 根据选择日期计算准确的区块范围（每天8:00-次日7:59 UTC+8）
- **交易获取**: 根据区块范围获取代币交易记录
- **交易筛选**: 根据代币对配置过滤掉非相关代币的交易，只保留配置中的目标代币交易

**交易分类与识别**:
- **有效交易识别**: 识别代币对配置中买入为erc20代币的交易
- **交易对匹配**: 自动识别USDT→ZKJ、ZKJ→USDT等交易对关系
- **时间序列分析**: 按时间顺序分析交易，识别完整的交易循环

**有效交易额计算**
- 所有有效交易的价值总和
- USDT/ERC20交易对以USDT数量计价
- ERC20/ERC20代币交易对以代币数量*单价计价

**损失计算逻辑**:
- **交易磨损计算**: 
  - 所有符合的交易代币的总卖出价值 - 总买入价值的差值
- **Gas费用统计**:
  - 所有符合的交易的Gas消耗按当时的BNB价格转换为USDT价值

**ERC20代币价格获取机制**
- **价格映射构建**: 为所有配置的代币（USDT、ZKJ、KOGE、AB、BR等）构建价格映射表
- **USDT基准价格**: 稳定币USDT作为基准，价格固定为1 USDT
- **BNB原生代币**: 通过BSCScan专用API获取BNB/USDT实时价格
- **价格缓存机制**: 代币价格缓存10分钟，减少重复价格查询
- **价格换算逻辑**: 
  - 所有代币余额统一换算为USDT价值
  - 交易磨损计算基于USDT价格差异
  - Gas费用按BNB价格转换为USDT成本

**积分计算优化**:
- **BSC链特殊处理**: BSC链上的交易积分自动翻倍计算
- **积分评估**: 余额积分+交易积分

**3. 共享数据机制**
- **区块范围复用**: 多个钱包分析时，共享相同的时间区块范围
- **价格映射共享**: 预先获取所有代币的价格映射表，避免重复价格查询
- **批量优化**: 并发分析多个钱包，但复用共享的基础数据

**4. 结果缓存策略**
- **钱包级缓存**: 每个钱包的分析结果缓存5分钟
- **交易数据缓存**: 原始交易数据缓存更长时间，减少BSCScan查询
- **价格数据缓存**: 代币价格数据缓存10分钟，平衡实时性和性能

### 4. API服务层 (API Services)
```
services/api/
├── api-client.ts          # HTTP客户端
├── rate-limiter.ts        # 速率限制
└── bscscan-service.ts     # BSCScan API
```

#### API管理机制详解

**1. BSCScan API Key管理**
- **多Key轮换策略**: 系统维护多个API Key，按照轮询方式分配使用，避免单Key限流
- **配置来源**: 从`public/config/app-config.json`中读取API Key配置，支持动态添加和禁用
- **Key状态监控**: 实时监控每个Key的使用状态，自动跳过失效的Key
- **负载均衡**: 请求均匀分布到所有可用Key上，并发数=active Key数量

**2. 智能速率限制机制**
- **动态限流**: BSCScan官方限制5次/秒，系统动态调整1.5-4次/秒。初始1.5次/秒，确保稳定性。API成功率>95%时，逐步提升到2.5次/秒。N个API Key时，可达到N×2.5次/秒总体效率。出现429限流错误时，自动降低到1次/秒。错误率降低后，逐步恢复到正常速率。
- **队列管理**: 维护请求队列，按顺序处理，避免突发请求导致限流，最大50个请求排队。
- **并发控制**: 并发数=配置文件中active的API Key数量，动态调整
- **自适应调整**: 根据API成功率和错误类型实时调整请求频率

**3. 容错与重试策略**
- **三级重试**: 请求失败后自动重试最多3次，每次重试间隔递增
- **错误分类**: 区分网络错误、API限流、数据错误，采用不同处理策略
- **健康检查**: 定期检测API可用性，及时发现和处理异常Key

**4. 请求优化机制**
- **请求去重**: 相同参数的并发请求只执行一次，其他请求共享结果
- **优先级队列**: 用户交互请求优先级高于后台数据同步请求
- **超时控制**: 设置合理的请求超时时间，单次请求15秒超时，避免长时间等待

**5. API工作原理架构图**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户请求      │───▶│   缓存检查      │───▶│  API服务层      │
│  钱包分析       │    │  5-10分钟TTL    │    │ BSCScan单例     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                ▲                       │
                                │                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   返回结果      │◀───│   数据缓存      │◀───│  速率限制器     │
│   更新UI        │    │   结果存储      │    │ 动态限流策略    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
                              ┌─────────────────┐    ┌─────────────────┐
                              │   重试机制      │◀───│  API Key轮换    │
                              │ 3次重试+降级    │    │Key[0]→Key[1]→..│
                              └─────────────────┘    └─────────────────┘
                                       ▲                       │
                                       │                       ▼
                              ┌─────────────────┐    ┌─────────────────┐
                              │   BSCScan API   │◀───│   HTTP请求      │
                              │  官方接口调用   │    │  实际API调用    │
                              └─────────────────┘    └─────────────────┘

                    ┌────────────── 共享数据优化机制 ──────────────┐
                    │                                              │
         ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
         │   区块范围      │  │   代币价格      │  │   BNB价格       │
         │   全局1次       │  │   映射表1次     │  │   实时1次       │
         └─────────────────┘  └─────────────────┘  └─────────────────┘
                    │                                              │
                    └──────────── 多个钱包共享使用 ──────────────┘
```


### 5. 数据服务层 (Data Services)
```
services/data/
├── cache-service.ts       # 缓存服务
└── [other-data-services]  # 其他数据服务
```

**功能**：
- **TTL缓存**: 自动过期清理
- **LRU策略**: 智能内存管理
- **批量操作**: 性能优化

### 6. 工具层 (Utils Layer)
```
lib/utils/
├── time-utils.ts          # 时间工具
└── token-price-utils.ts   # 价格工具
```

**职责**：
- 纯函数工具
- 数据格式化
- 通用计算逻辑

## 🔄 分层架构数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                    🖥️ 应用层 (App Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  app/page.tsx (Server Component)                               │
│       │ RSC渲染, SEO优化                                        │
│       ▼                                                         │
│  components/app-shell.tsx (Client Component)                   │
│       │ 客户端交互, 路由管理                                    │
│       ▼                                                         │
│  业务组件 (dashboard, revenue-display, points-calculator...)   │
└─────────────────────┬───────────────────────────────────────────┘
                      │ 用户交互事件
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  ⚡ 状态管理层 (State Layer)                     │
├─────────────────────────────────────────────────────────────────┤
│  Zustand Store                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │  wallet-store   │  │   ui-store      │                      │
│  │  钱包数据状态   │  │   UI状态管理    │                      │
│  │  - wallets[]    │  │   - activeTab   │                      │
│  │  - walletData[] │  │   - loading     │                      │
│  │  - hasQueried   │  │   - errors      │                      │
│  └─────────────────┘  └─────────────────┘                      │
│       │ 持久化到localStorage        │ 临时状态                │
└───────┼─────────────────────────────┼───────────────────────────┘
        │ 调用业务服务                │ UI状态变更
        ▼                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                 🧠 业务服务层 (Business Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │ BalanceService  │  │TransactionService│                     │
│  │ 余额分析服务    │  │ 交易分析服务     │                     │
│  │ - 多代币余额    │  │ - 交易分类       │                     │
│  │ - 价格转换      │  │ - 损失计算       │                     │
│  │ - 积分计算      │  │ - 交易对匹配     │                     │
│  └─────────────────┘  └─────────────────┘                      │
│       │ 数据处理逻辑            │ 业务计算                      │
└───────┼─────────────────────────┼───────────────────────────────┘
        │ API调用                 │ 调用API服务
        ▼                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  🌐 API服务层 (API Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ BSCScanService  │  │  RateLimiter    │  │  APIClient      │ │
│  │ BSC API管理     │  │  速率限制器     │  │  HTTP客户端     │ │
│  │ - Key轮换      │  │  - 队列管理     │  │  - 请求封装     │ │
│  │ - 请求封装      │  │  - 并发控制     │  │  - 错误处理     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│       │ 统一API调用           │ 限流控制      │ HTTP请求        │
└───────┼─────────────────────────┼─────────────┼─────────────────┘
        │ 缓存检查                │             │ 网络请求
        ▼                         ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│                 💾 数据服务层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │  CacheService   │  │  SharedCache    │                      │
│  │  缓存服务       │  │  共享缓存       │                      │
│  │  - TTL管理     │  │  - 区块范围     │                      │
│  │  - LRU策略     │  │  - 价格映射     │                      │
│  │  - 批量操作     │  │  - BNB价格      │                      │
│  └─────────────────┘  └─────────────────┘                      │
│       │ 缓存命中/未命中                                         │
└───────┼─────────────────────────────────────────────────────────┘
        │ 工具函数调用
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                 🔧 工具层 (Utils Layer)                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  PointsUtils    │  │   TimeUtils     │  │ TokenPriceUtils │ │
│  │  积分计算工具   │  │   时间处理工具  │  │  价格计算工具   │ │
│  │  - 余额积分     │  │   - UTC8转换    │  │  - 价格映射     │ │
│  │  - 交易积分     │  │   - 区块查询    │  │  - 汇率转换     │ │
│  │  - BSC双倍     │  │   - 时间格式化  │  │  - 缓存策略     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│       │ 纯函数计算                                              │
└───────┼─────────────────────────────────────────────────────────┘
        │ 外部API调用
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                   🌍 外部服务 (External APIs)                   │
├─────────────────────────────────────────────────────────────────┤
│  BSCScan API: 区块链数据查询                                   │
│  - 钱包余额查询 (balance, tokenbalance)                        │
│  - 交易记录查询 (txlist, tokentx)                              │
│  - 区块信息查询 (getblocknobytime)                             │
│  - BNB价格查询 (bnbprice)                                      │
└─────────────────────────────────────────────────────────────────┘

数据流向: 用户操作 → 状态更新 → 业务处理 → API调用 → 缓存存储 → 工具计算 → 外部服务
返回流向: 外部数据 → 工具处理 → 缓存存储 → API封装 → 业务逻辑 → 状态更新 → UI更新
```

## 🔄 交易分析流程图

```
                 ┌───── 交易分析服务入口 ─────┐
                 │  输入: 钱包地址 + 日期     │
                 └─────────────┬─────────────┘
                               │
                               ▼
                 ┌─────────────────────────┐
                 │    1. 获取区块范围      │
                 │ - 日期转UTC+8时间戳     │  
                 │ - 时间戳转区块号        │
                 │ - 确定查询区块范围      │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │ 2. 获取所有代币交易     │
                 │ - 1次API调用(优化)      │
                 │ - tokentx获取全部代币   │
                 │ - 区块范围内所有交易    │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │ 3. 客户端过滤特定代币   │
                 │ - 过滤出配置的代币      │
                 │ - USDT/ZKJ/KOGE/AB/BR   │
                 │ - 丢弃无关代币交易      │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │ 4. 识别交易对模式       │
                 │ - 按交易哈希分组        │
                 │ - 识别发出/接收代币     │
                 │ - 匹配配置的交易对      │
                 │ ✅ 得到所有符合条件交易 │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │   5. 过滤有效交易       │
                 │ - 从符合条件交易中筛选  │
                 │ - 买入ERC20代币的交易   │
                 │ - 过滤掉卖出换稳定币    │
                 │ - 纯逻辑筛选，无需价格  │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │   6. 构建价格映射表     │
                 │ - 稳定币价格(USDT=1)    │
                 │ - 实时BNB价格查询       │
                 │ - 交易推算ERC20价格     │
                 │ - 生成完整价格映射      │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │    7. 并行计算阶段      │
                 └─────────┬───────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 🚀 交易磨损计算 │ │ ⛽ Gas费用计算  │ │ 📊 有效交易量计算│
│ - 所有符合交易  │ │ - 所有符合交易  │ │ - 有效交易列表  │
│ - 卖出-买入价值 │ │ - Gas×BNB价格   │ │ - 数量×价格求和 │
│ - 磨损=差值     │ │ - 转换USDT价值  │ │ - 总交易量USD   │
└─────────────────┘ └─────────────────┘ └─────────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │ 等待所有并行任务完成
                           ▼
                           │
                           ▼
                 ┌─────────────────────────┐
                 │      7. 返回结果        │
                 │ {                       │
                 │   validTransactions,    │
                 │   tradingLoss,          │
                 │   gasLoss,             │
                 │   priceMap             │
                 │ }                       │
                 └─────────────────────────┘

    ┌──── API优化策略 ────┐    ┌──── 价格计算机制 ────┐    ┌──── 并行计算优化 ────┐
    │                      │    │                      │    │                      │
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ API调用优化     │ │ 价格推算算法    │ │ 并行vs串行计算  │
│ 1次调用 vs 5次  │ │ USDT→ZKJ→USDT   │ │ 3任务同时执行   │
│ 减少80%API消耗  │ │ 交易对价格推导  │ │ 减少计算等待时间│
│ 速率限制友好    │ │ 稳定币=1USD     │ │ 提升响应速度    │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```




